<div id="widget-amigos">
    <h2>Lista de tus amigos:</h2>
    <div class="input-group col-xs-8 col-sm-6 col-md-4 col-lg-5 pull-right">
        <input type="text" class="form-control"
               placeholder="Filtrar por nombre" id="filtro-nombre"/>
        <span class="input-group-btn">
             <button class="btn" type="submit"><span class="glyphicon glyphicon-search"></span></button>
        </span>
    </div>

    <table class="table table-hover">
        <thead>
        <tr>
            <th>Nombre</th>
            <th>Email</th>
            <th>Mensajes sin leer</th>
            <th class="col-md-1"></th>
        </tr>
        </thead>
        <tbody id="tablaCuerpo">
        </tbody>
    </table>
</div>
<script>
    var usuarios;
    function cargarAmigos() {
        $.ajax({
            url : URLbase + "/usuarios",
            type : "GET",
            data : {},
            dataType : 'json',
            headers : {
                "token" : token
            },
            success : function(respuesta) {
                usuarios = respuesta;
                actualizarTabla(usuarios);
            },
            error : function(error) {
                $("#contenedor-principal").load("widget-login.html");
            }
        });
    }
    function cargarMensajesNoLeidos(email) {
        $.ajax({
            url : URLbase + "/mensajes/noleidos",
            type : "GET",
            data : {
                destino : email,
                leido : false
            },
            dataType : 'json',
            headers : {
                "token" : token
            },
            success : function(respuesta) {
                var element = document.getElementById(email);
                console.log(element.innerHTML+" || "+respuesta.length);
                element.innerHTML=respuesta.length
            },
            error : function(error) {
                $("#contenedor-principal").load("widget-login.html");
            }
        });
    }
    function actualizarTabla(usuariosMostrar) {
        $("#tablaCuerpo").empty(); // Vaciar la tabla
        for (i = 0; i < usuariosMostrar.length; i++) {
            cargarMensajesNoLeidos(usuariosMostrar[i].email);
            //Falta poner el valor de sinLeer, que no lo pilla.
            $("#tablaCuerpo").append(
                "<tr id="+usuariosMostrar[i]._id+">" + "<td>"
                + "<a onclick=mostrarChat('"+usuariosMostrar[i].email+"')>"+usuariosMostrar[i].nombre + "</a>" +"</td>" + "<td>"
                + usuariosMostrar[i].email + "</td>"+"<td>" + "<p id="+usuariosMostrar[i].email+">"+"caca"+"</p>"
                                + "</td>"+"</tr>");
        }
    }
    cargarAmigos();

    $('#filtro-nombre').on('input',function(e){
        var usuariosFiltrados = [];
        var nombreFiltro = $("#filtro-nombre").val();
        for (i = 0; i < usuarios.length; i++) {
            if (usuarios[i].nombre.indexOf(nombreFiltro) != -1 ){
                usuariosFiltrados.push(usuarios[i]);
            }
        }
        actualizarTabla(usuariosFiltrados);
    });

    function widgetUsuariosAmigos(){
        $( "#contenedor-principal" ).load( "widget-amigos.html");
    }

    function mostrarChat(email) {
        emailUsuarioSeleccionado = email;
        $( "#contenedor-principal" ).load( "widget-chat.html" );
    }


</script>